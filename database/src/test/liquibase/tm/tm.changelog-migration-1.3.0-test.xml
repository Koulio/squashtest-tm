<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) 2010 - 2012 Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
     http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	
	<include file="../../../main/liquibase/tm/tm.changelog-1.3.0.xml" relativeToChangelogFile="true" />     

	<changeSet id="1.3.0.create-feat1112-test-tmp-table" author="bsiri">
		<createTable tableName="FEAT_TMP_TABLE">
			<column name="ancestor_id" type="BIGINT"/>
			<column name="descendant_id" type="BIGINT"/>
			<column name="depth" type="java.sql.Types.TINYINT"/>
		</createTable>
	
	</changeSet>

	
	<changeSet id="1.3.0.check-tcln-closure-setup" author="bsiri">
		<sql>
			delete from FEAT_TMP_TABLE;
			
			insert into FEAT_TMP_TABLE values
				(130, 130, 0),
				(131, 131, 0),
				(132, 132, 0),
				(133, 133, 0),
				(134, 134, 0),
				(135, 135, 0),
				(136, 136, 0),
				(137, 137, 0),
				(138, 138, 0),
				(130, 131, 1),
				(130, 133, 1), 
				(130, 132, 2),
				(130, 134, 2),
				(130, 135, 2),
				(130, 136, 2),
				(130, 137, 2),
				(130, 138, 2),
				(131, 132, 1),
				(133, 134, 1),
				(133, 135, 1),
				(133, 136, 1),
				(133, 137, 1),
				(133, 138, 1) 
		</sql>
	</changeSet>
	<changeSet id="1.3.0.check-tcln-closure-test" author="bsiri">
	
		<!--  Here we compare FEAT_TMP_TABLE and a subset of TCLN_CLOSURE_TABLE restricted to some ids. Their content must be equal, we test this
		by testing that each contain all the lines of the other one. -->
		<preConditions>
			<!--  check that there are no ancestor in the closure table that have a descendant not listed in the tmp table -->
			<sqlCheck expectedResult="0">
				select count(clos1.ancestor_id) from TCLN_RELATIONSHIP_CLOSURE clos1 
				where 
					clos1.ancestor_id in (130, 131, 132, 133, 134, 135, 136, 137, 138)
				and 
					clos1.descendant_id not in (
					select tmp.descendant_id from FEAT_TMP_TABLE tmp
					where tmp.ancestor_id = clos1.ancestor_id	
					and tmp.depth = clos1.depth
				)
			</sqlCheck>	 	
			
			<!--  complementary check : that there are no ancestor in the tmp table that have a descendant not listed in the closure table. -->
			<sqlCheck expectedResult="0">
				select count(tmp.ancestor_id) from FEAT_TMP_TABLE tmp 
				where 
					tmp.ancestor_id in (130, 131, 132, 133, 134, 135, 136, 137, 138)
				and 
					tmp.descendant_id not in (
					select clos1.descendant_id from TCLN_RELATIONSHIP_CLOSURE clos1
					where tmp.ancestor_id = clos1.ancestor_id	
					and tmp.depth = clos1.depth
				)
			</sqlCheck>	
			
		</preConditions>
		<comment>
			130 contains 131 and 133; 
			131 contains 132;
			133 contains 134, 135, 136, 317, 138.
			This test ensures that the hierarchy was fully expanded in the closure table.
		</comment>
	</changeSet>
	
	<changeSet id="1.3.0.delete-feat1112-test-tmp-table" author="bsiri">
		<dropTable tableName="FEAT_TMP_TABLE"/>	
	</changeSet>
		
</databaseChangeLog>